- name: Delete redmine dir for sec_installation
  shell: rm -rf /data/wwwroot/redmine
    
- name: Clone redmine in Websoft9 
  git:
    repo: "{{redmine_url}}"
    dest: "/data/wwwroot/redmine"

- name: Create dir for redmine
  file: 
    state: directory
    path: "{{item}}"
  loop: 
    - /data/wwwroot/redmine/volumes
    - /data/db/mysql

- name: Run docker-compose 
  shell: | 
    docker-compose -f docker-compose-production.yml up -d
    sleep 30
  args:
    chdir: /data/wwwroot/redmine

- name: Set soft link for redmine
  file:
    src: '{{item.src}}'
    dest: '{{item.dest}}'
    state: link
    force: yes
  with_items:
  - {src: /data/wwwroot/redmine/volumes/mysql_data/,dest: /data/db/mysql/data}
  - {src: /data/wwwroot/redmine/volumes/mysql_config/conf.d/,dest: /data/db/mysql/config}
  - {src: /data/wwwroot/redmine/volumes/mysql_config/conf.d/,dest: /data/config/mysql}

# check service and version
- name: Check redmine service 
  shell: echo "redmine" `docker inspect redmine |grep -i status`
  register: check_redmine_service
  notify: check_redmine_service
    
- name: Check redmine version
  shell: >
    sudo echo "redmine version:" $(docker inspect redmine:latest |grep REDMINE_VERSION |head -1 |cut -d= -f2) |sudo tee -a /data/logs/install_version.txt  
- name: Check mysql version
  shell: >
    sudo echo "mysql version:" $(docker images |grep mysql |awk '{print $2}') |sudo tee -a /data/logs/install_version.txt 
